<!DOCTYPE html>
<html>
<head>
	<title>System Maker</title>
	<link href="main.css" rel="stylesheet">
	<!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.1/knockout-debug.js"></script>
	<!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"></script>-->
	<script type="text/javascript" src= "../../Tools/knockout-3.4.0.js"></script>
	<script src="https://cdn.rawgit.com/konvajs/konva/1.6.5/konva.js"></script>
	<script type="text/javascript" src= "../../Tools/knockout-konva.js"></script>
	<script type="text/javascript" src= "main.js"></script>
	<script type="text/javascript" src= "planet.js"></script>
	<script type="text/javascript" src= "star.js"></script>
	<script type="text/javascript" src= "system.js"></script>
	<script >


		
		function Orbit ( distance, eccentricty, center){
			var orbit = {};
			
			orbit.eccentricty= ko.observable(eccentricty);
			orbit.baseDistance = ko.observable(distance);
			orbit.distance = ko.pureComputed(function (){
				var multiplier = orbit.center() && orbit.center().orbitAdjustment 
					? orbit.center().orbitAdjustment()
					: 1;
				return orbit.baseDistance()*multiplier;
			});
			orbit.center = ko.observable(center);
			
			orbit.minDistance = ko.pureComputed(()=>(1-orbit.eccentricty())*orbit.distance());
			orbit.maxDistance = ko.pureComputed(()=>(1+orbit.eccentricty())*orbit.distance());
			
			return orbit;
		}

		var root = {};
		function load ()
		{
			root.cosmos = {
				systems: ko.observableArray([])
			};
			root.events = {};
			root.lookup = lookup;
			
			for(var i =0;i< 100;i++)
			{
				root.cosmos.systems.push(generateSystem());
			}
			
			root.currentSystem = ko.observable(root.cosmos.systems()[0]);
			root.currentStar = ko.observable(root.currentSystem().stars()[0]);
			root.currentPlanet = ko.observable(root.currentSystem().planets()[0]);
			
			root.editStar = ko.observable(false);
			root.editPlanet = ko.observable(false);
			
			root.events.planetClick = function (data){root.currentPlanet(data)};
			root.events.starClick = function (data){root.currentStar(data)};
			root.events.systemClick = function (data){
				root.currentSystem(data);
				root.currentStar(data.stars()[0]);
				root.currentPlanet(data.planets()[0]);
			};
			
			root.deletePlanet = function (){
				root.currentSystem().planets.remove(root.currentPlanet());
				root.currentPlanet(root.currentSystem().planets()[0]);
			}
			root.addMoon = function (){
				var planet = root.currentPlanet();
				if(planet.orbit().center()!=planet.star()) 
				{
					//TODO: perhaps add sister moon?
					console.log("THIS IS ALREADY A MOON!")
					return;
				}
				var moon = Planet("terrestrial",1,new Orbit(planet.majorMoons(),0,planet),generateAlternatePlanetTypes());
				planet.majorMoons(planet.majorMoons()+1);
				root.currentSystem().planets.push(moon);
			}
			root.addPlanet = function (){
				var planet = generatePlanet(
					root.currentSystem().gasGiantArrangement(),
					root.currentSystem().nextBestOrbit()
						[root.currentStar().guid],
					root.currentStar());
				root.currentSystem().planets.push(planet);
				root.currentPlanet(planet);
			}
			
			ko.applyBindings(root,document.getElementById('content'));
		}
	</script>
</head>
<body onload="load()">
	<div id = "content">
		<div id="textInterface">
		<div data-bind="with: currentStar" id="star">
			STAR <br>
			mass: <span data-bind="text:mass"></span>
			<!-- ko if:$root.editStar -->
			<input type="number" min=".1" max="2" step=".05" data-bind="value:mass"/>
			<input type="range" min=".1" max="2" step=".05" data-bind="value:mass"/>
			<!-- /ko  -->
			<br>
			luminosity: <span data-bind="text:luminosity"></span><br>
			stage: <span data-bind="text:stage"></span><br>
			type: <span data-bind="text:size().starclass"></span><br>
			age: <span data-bind="text:age"></span>
			<!-- ko if:$root.editStar -->
			<input type="number" min="0" max="13.5" step=".5" data-bind="value:age"/>
			<input type="range" min="0" max="13.5" step=".5" data-bind="value:age"/>
			<!-- /ko  -->
			<br>
			radius: <span data-bind="text:radius"></span><br>
			Orbit: <span data-bind="text:orbit().minDistance"></span> to <span data-bind="text:orbit().maxDistance"></span> <br>
			Limits <span data-bind="text:innerLimit"></span> to <span data-bind="text:outerLimit"></span> <br>
			<!-- ko if:$root.editStar -->
				shift planets<input type="number" step=".1" data-bind="value:planetAdjustment"/><br>
			<!-- /ko  -->
			<input type="checkbox" value="true" data-bind="checked:$root.editStar"> Edit Star<br>
			<!-- ko if:$root.editStar -->
				<button data-bind="click:$root.deletePlanet">Delete Planet</button>
				<button data-bind="click:$root.addPlanet">Add Planet</button>
				<button data-bind="click:$root.addMoon">Add Moon</button>
			<!-- /ko -->
		</div>
		<div data-bind="with: currentPlanet" id="planet">
			PLANET <br>
			type: <span data-bind="text:terrain"></span><br>
			<!-- ko if:$root.editPlanet -->
				<input type="checkbox" value="true" data-bind="checked:alternateTypes.canBeGarden"> Garden
				<input type="checkbox" value="true" data-bind="checked:alternateTypes.canBeSulfur"> Sulfur<br>
				<select data-bind="options:$root.lookup.planetTypes, value:type"></select><br>
			<!-- /ko -->
			temperature: <span data-bind="text:temperature"></span><br>
			<!-- ko if:temperature() > -40 && temperature() < 180 -->
				climate: <span data-bind="text:temperatureRange"></span><br>
			<!-- /ko -->
			<!-- ko if:type()=='terrestrial' -->
				pressure: <span data-bind="text:atmosphere.pressureClass"></span>
				(<span data-bind="text:atmosphere.pressure"></span>)<br>
				gravity: <span data-bind="text:gravity"></span><br>
				blackbody: <span data-bind="text:blackBody"></span><br>
				atmosphereic mass: <span data-bind="text:atmosphere.mass"></span>
				<!-- ko if:$root.editPlanet -->
				<input type="number" min="0" max="2.0" step=".1" data-bind="value:atmosphere.naturalMass"/>
				<!-- /ko -->
				<br>
				toxicity: <span data-bind="text:atmosphere.toxicity"></span><br>
				tags: <span data-bind="foreach:atmosphere.tags">
					<span data-bind="text:$data"></span>
				</span><br>
				<!-- ko if:terrain() =="Garden" -->
					Air Quality: <span data-bind="text:atmosphere.marginal"></span><br>
				<!-- /ko -->
				<!-- ko if:hydrographicCoverage -->
					Ocean Coverage: <span data-bind="text:hydrographicCoverage"></span><br>
				<!-- /ko -->
				affinity: <span data-bind="text:affinity"></span><br>
				resource Value: <span data-bind="text:resourceValue"></span><br>
			<!-- /ko -->
			diameter: <span data-bind="text:diameter"></span>
			<!-- ko if:$root.editPlanet() && type()=='terrestrial' -->
				<input type="range" min="0" max="1.0" step=".1" data-bind="value:diameterSeed"/>
			<!-- /ko --><br>
			<!-- ko if:$root.editPlanet() && type()=='giant' -->
				<input type="range" min="3" max="18" step="1" data-bind="value:gasGiantMassSeed"/><br>
			<!-- /ko -->
			density: <span data-bind="text:density"></span>
			<!-- ko if:$root.editPlanet() && type()=='terrestrial' -->
				<input type="range" min=".3" max=".7" step=".1" data-bind="value:densitySeed"/>
			<!-- /ko --><br>
			size: <span data-bind="text:size"></span>
			<!-- ko if:$root.editPlanet -->
			<input type="number" min="1" max="4" step="1" data-bind="value:size"/>
			<!-- /ko -->
			<br>
			orbit: <span data-bind="text:orbit().distance"></span>
			<!-- ko if:$root.editPlanet -->
				<input type="number" data-bind="value:orbit().baseDistance, attr:{step:orbit().baseDistance()/10}"/>
			<!-- /ko -->
			<br>
			minor moons: <span data-bind="text:minorMoons"></span><br>
			major moons: <span data-bind="text:majorMoons"></span><br>
			 
			<input type="checkbox" value="true" data-bind="checked:$root.editPlanet"> Edit Planet<br>

		</div>
		</div>
		<!-- ko Konva.Stage: {width: 800, height:800 } -->
			<!-- ko Konva.Layer: {} -->
				<!-- ko foreach:currentSystem().stars() -->
					<!-- ko Konva.Group: {x:0,y:Number($index()) * 100} -->
						<!-- ko Konva.Rect: {x:0, y:0, width: 800, height:100, fill:'black', stroke: 'black', strokeWidth: 0 } --> 
						<!-- /ko -->
						<!-- TODO: draw asteroids better! -->
						<!-- ko Konva.Circle: {x:50-drawnRadius(), y:50, radius:drawnRadius, fill:drawnColor, stroke: drawnColor, strokeWidth: 0, click: $root.events.starClick, data:$data} --> 
						<!-- /ko -->
						<!-- ko if: $root.currentPlanet().orbit().center() == $parent-->
							<!-- ko with: $root.currentPlanet() -->
								<!-- ko Konva.Circle: {x:$parent.displayPosition(orbit().distance()), y:50, radius:50, stroke: 'white', strokeWidth: 5, click: $root.events.planetClick, data:$data } -->
								<!-- /ko -->
							<!-- /ko -->
						<!-- /ko -->
						<!-- ko foreach:$root.currentSystem().planets -->
							<!-- ko if: $parent == $data.orbit().center()-->
								<!-- ko Konva.Circle: {x:$parent.displayPosition(orbit().distance()), y:50, radius:drawnRadius, fill:drawnColor, stroke: drawnColor, strokeWidth: 0, click: $root.events.planetClick, data:$data } -->
								<!-- /ko -->
								<!-- moons -->
								<!-- ko foreach:$root.currentSystem().planets-->
									<!-- ko if: $parent == $data.orbit().center()-->
										<!-- ko Konva.Circle: {x:$data.star().displayPosition($parent.orbit().distance())+$data.orbit().distance()*10, y:75, radius:drawnRadius, fill:drawnColor, stroke: drawnColor, strokeWidth: 0, click: $root.events.planetClick, data:$data } -->
										<!-- /ko -->
									<!-- /ko -->
								<!-- /ko -->
							<!-- /ko -->
						<!-- /ko -->
						<!-- ko Konva.Line: {points:[$data.displayPosition($data.snowLine()),0,$data.displayPosition($data.snowLine()),100], stroke: "white", strokeWidth: 1} --> 
						<!-- /ko -->
						<!-- ko Konva.Line: {points:[$data.displayPosition($data.hotHabitableZone()),0,$data.displayPosition($data.hotHabitableZone()),100], stroke: "green", strokeWidth: 1} --> 
						<!-- /ko -->
						<!-- ko Konva.Line: {points:[$data.displayPosition($data.coldHabitableZone()),0,$data.displayPosition($data.coldHabitableZone()),100], stroke: "green", strokeWidth: 1} --> 
						<!-- /ko -->
						<!-- ko Konva.Line: {points:[$data.displayPosition($data.innerLimit()),0,$data.displayPosition($data.innerLimit()),100], stroke: "red", strokeWidth: 1} --> 
						<!-- /ko -->
						<!-- ko Konva.Line: {points:[$data.displayPosition($data.outerLimit()),0,$data.displayPosition($data.outerLimit()),100], stroke: "red", strokeWidth: 1} --> 
						<!-- /ko -->
						<!-- ko foreach:$root.currentSystem().stars() -->
							<!-- ko if: $parent != $data && $data.orbit().center() == $parent-->
								<!-- ko Konva.Line: {points:[$parent.displayPosition($data.orbit().minDistance()),0,$parent.displayPosition($data.orbit().maxDistance()),100], stroke: drawnColor, strokeWidth: 1} --> 
								<!-- /ko -->
								<!-- ko Konva.Circle: {x:$parent.displayPosition($data.orbit().distance()), y:50, radius:20, fill: drawnColor, stroke: drawnColor, strokeWidth: 5, click: $root.events.starClick, data:$data } -->
								<!-- /ko -->
							<!-- /ko -->
							<!-- ko if: $parent != $data && $parent.orbit().center() == $data-->
								<!-- ko Konva.Line: {points:[$parent.displayPosition($parent.orbit().minDistance()),0,$parent.displayPosition($parent.orbit().maxDistance()),100], stroke: drawnColor, strokeWidth: 1} --> 
								<!-- /ko -->
								<!-- ko Konva.Circle: {x:$parent.displayPosition($parent.orbit().distance()), y:50, radius:20, fill: drawnColor, stroke: drawnColor, strokeWidth: 5, click: $root.events.starClick, data:$data } -->
								<!-- /ko -->
							<!-- /ko -->
						<!-- /ko -->
					<!-- /ko -->
				<!-- /ko -->
				<!-- ko Konva.Group: {x:0,y:currentSystem().stars().length*100} -->
					<!-- ko Konva.Rect: {x:0, y:0, width: 500, height:500, fill:'black', stroke: 'black', strokeWidth: 0 } --> 
					<!-- /ko -->
					<!-- ko foreach:cosmos.systems -->
						<!-- ko Konva.Circle: {x:location.x()*5, y:location.y()*5, radius:2, fill:stars()[0].drawnColor, stroke: stars()[0].drawnColor, strokeWidth: 0, click: $root.events.systemClick, data:$data } -->
						<!-- /ko -->
						<!-- ko if:isHabitable -->
							<!-- ko Konva.Circle: {x:location.x()*5+5, y:location.y()*5+5, radius:1, fill:"green", stroke: "green", strokeWidth: 0} -->
							<!-- /ko -->
						<!-- /ko -->
					<!-- /ko -->
					<!-- ko Konva.Circle: {x:currentSystem().location.x()*5, y:currentSystem().location.y()*5, radius:15, fill:"rgba(0,0,0,0)", stroke: "white", strokeWidth: 1} -->
					<!-- /ko -->
				<!-- /ko -->
				<!-- ko Konva.Group: {x:500,y:currentSystem().stars().length*100} -->
					<!-- ko Konva.Rect: {x:0, y:0, width: 300, height:300, fill:'#111111', stroke: 'white', strokeWidth: 1 } --> 
					<!-- /ko -->
					<!-- ko with:$root.currentPlanet -->
						<!-- ko Konva.Circle: {x:150, y:150, radius:50, fill:drawnColor, stroke: drawnColor, strokeWidth: 1} -->
						<!-- /ko -->
						<!-- ko foreach:$root.currentSystem().planets() -->
							<!-- ko if:$data.orbit().center() == $parent -->
								<!-- ko Konva.Circle: {x:$data.orbit().distance()*30+15, y:200, radius:drawnRadius()*5, fill:drawnColor, stroke: drawnColor, strokeWidth: 1,click: $root.events.planetClick, data:$data} -->
								<!-- /ko -->
							<!-- /ko -->
						<!-- /ko -->
					<!-- /ko -->
				<!-- /ko -->

			<!-- /ko -->
		<!-- /ko -->
	</div>
</body>