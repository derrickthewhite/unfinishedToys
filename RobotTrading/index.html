<html>
	<head>
		<title>Techopoloy</title>
		<link href="main.css" rel="stylesheet">
		<script type="text/javascript" src= "../../Tools/knockout-3.4.0.js"></script>
		<script type="text/javascript" src= "tools.js"></script>
		<script type="text/javascript" src= "cards.js"></script>
		<script type="text/javascript" src= "construction.js"></script>
		<script>
			
			var game = {};
			function player (name)
			{
				var self = this;
				self.name = name;
				self.constructions = ko.observableArray();
				var constructionMap = {};
				self.cards = ko.observableArray();
				self.id = getID();
				self.addCards = function (cards){
					for(var card of cards) self.cards.push(card);
				};
				self.addConstruction = function(type,number){
					var construction = constructionMap[type.name];
					if(!construction)
					{
						construction = new Construction(type,self,0);
						constructionMap[type.name] = construction;
						self.constructions.push(construction);
					}
					construction.number(construction.number()+number);
				};
				
				self.totalFlow = ko.pureComputed(function (){
					var result = {}
					result.inputs = {};
					result.outputs = {};
					result.totals = {};
					for(var construction of self.constructions())
					{
						for(var input of construction.cost())
						{
							if(!result.inputs[input.resource]) result.inputs[input.resource]=0;
							result.inputs[input.resource]+=input.value;
							if(!result.totals[input.resource]) result.totals[input.resource]=0;
							result.totals[input.resource]-=input.value;
						}
						for(var output of construction.output())
						{
							if(!result.outputs[output.resource]) result.outputs[output.resource]=0;
							result.outputs[output.resource]+=output.value;
							if(!result.totals[output.resource]) result.totals[output.resource]=0;
							result.totals[output.resource]+=output.value;
						}
					}
					return result;
				});
			}
			
			
			game.mode = ko.observable("setup"); // mainView, invention, setup
			game.players = ko.observableArray();
			game.currentPlayer = ko.observable(0);
			
			//setup
			game.newPlayerName = ko.observable("");
			game.addPlayer = function (){
				game.players.push(new player(game.newPlayerName()));
			};
			game.startGame = function ()
			{
				var steel = new ConstructionType("Steel",[],"starting");
				var costsSteel = effects.fuel2C;
				costsSteel.target = "Steel";
				var robot = new ConstructionType("Robot",[effects.worthless,effects.manipulator,effects.automatic,costsSteel,effects.limit1],"starting");
				game.mode("invention");
				for(var player of game.players())
				{
					player.addCards(cards.draw(3));
					player.addConstruction(robot,2);
					player.addConstruction(steel,0);
				}
			};

			//building
			game.nextTurn = function (){
				if(game.hasValidInstructions())
				{
					var lastPlayer = game.players()[game.currentPlayer()];
					var nextPlayer = (game.currentPlayer()+1)%game.players().length;
					
					var flow = lastPlayer.totalFlow();
					//TODO -- synthetics might be a problem
					for(var construction of lastPlayer.constructions())
					{
						if(flow.totals[construction.name]!=0) 
							construction.number(construction.number()+flow.totals[construction.name]);
					}
					
					game.currentPlayer(nextPlayer);
					lastPlayer.addCards(cards.draw(lastPlayer.cards().length?2:3));
					game.mode("invention");
					game.cardsSelected([]);
				}
			}
			game.errors = ko.pureComputed( function() {
				var result = [];
				if(game.mode()=="mainView")
				{
					player = game.players()[game.currentPlayer()];
					var flow = player.totalFlow();
					for(var i in flow.inputs)
					{
						if(!flow.outputs[i])
						{
							result.push("Requires "+flow.inputs[i]+" "+i);
						}
						else if(flow.outputs[i]<flow.inputs[i])
							result.push("Requires "+(flow.inputs[i]-flow.outputs[i])+" more "+i);
					}
					for(var construction of player.constructions())
					{
						if(!construction.type.isMachine && construction.activateCount() > construction.number())
							result.push ("Burning "
								+ (construction.activateCount()-construction.number()) 
								+"more "+construction.name+" than you have!"
							);
						if(construction.type.limited 
							&& construction.activateCount() 
								> construction.number()*construction.type.limited
						)
							result.push("Used "+construction.activateCount()
								+" " +construction.name+ ", only can use "
								+construction.number()*construction.type.limited
							);
					}
					//TODO: verify manipulator chain
				}
				return result;
			});
			
			game.hasValidInstructions = ko.pureComputed(function (){
				return game.errors().length==0;
			});
			
			//invention
			game.cardForInvention = ko.observable();
			game.cardsSelected = ko.observableArray([]);
			game.inventionName = ko.observable("null");
			game.cardActivePlayer = ko.observable(0);
			game.fuelToUse = ko.observable();
			game.activePlayer = ko.computed (function (){
				return (game.cardActivePlayer()+game.currentPlayer())%game.players().length;
			});
			game.possibleFuels = ko.pureComputed(function (){
				var player = game.currentPlayer();
				var sofar = {};
				var result = [];
				
				for(var player of game.players())
					for(var invention of player.constructions())
						if(invention.type.inventor != player.name 
							&& !sofar[invention.type.name]
							&& !invention.type.isMachine)
						{
								sofar[invention.type.name] = true
								result.push(invention.type.name);
						}
				return result;
			});
			game.finalizeInvention = function (){
				var player = game.players()[game.currentPlayer()];
				var effects = game.cardsSelected().map((card)=> card.effect);
				effects = effects.length?effects.reduce((a,b)=> a.concat(b)):[];
				var type = new ConstructionType(game.inventionName(),effects,player);
				player.addConstruction(type,0);
				console.log(type);
				game.mode('mainView');
			}
			game.skipInventing = function (){
				game.mode('mainView');
			}
			game.addCard = function (){
				
				var card = game.cardForInvention()
				game.players()[game.currentPlayer()].cards.remove(card);
				card = JSON.parse(JSON.stringify(card));
				for(var effect of card.effect)
					if(effect.target == '<Fuel>')
					{
						console.log("replaceing <Fuel> with "+game.fuelToUse());
						effect.target = game.fuelToUse();
						card.name = card.name.replace('<Fuel>',effect.target);
					}
					else console.log("effect "+effect.name+" has no Fuel!",effect,card.effect);
				game.cardsSelected.push(card);
				
				game.cardActivePlayer((game.cardActivePlayer()+1)%game.players().length);
			}
			game.declineToAdd = function (){
				game.cardActivePlayer((game.cardActivePlayer()+1)%game.players().length);
			}



			function load()
			{
				ko.applyBindings(game,document.getElementById('main'));
			}
		</script>
	</head>
	<body onload="load()">
		<div id="main">
			<!-- ko if:game.mode()=='setup' -->
				New Player Name <input type = "text" data-bind="value:newPlayerName"></input> <br>
				<button data-bind="click:addPlayer"> Add Player</button> <br>
				<button data-bind="click:startGame"> Start Game </button> <br>
				
				<div data-bind="foreach:players">
					<div data-bind="text:name"></div>
				</div>
			<!-- /ko -->
			<!-- ko if:game.mode()!='setup' -->
				<h1>Current Player: <span data-bind="text:players()[currentPlayer()].name"></span></h1> <br>
			<!-- /ko -->
			<!-- ko if:game.mode()=='mainView' -->
				<button data-bind="click:nextTurn"> End Turn</button> <br>
			<!-- /ko -->
			<!-- ko if:game.mode()=='invention' -->
			
				<h2>Active Player: <span data-bind="text:players()[activePlayer()].name"></span></h2> <br>
				Invention Name <input type = "text" data-bind="value:inventionName"></input> <br>
				Next Card: <select data-bind=
					"value:cardForInvention,
					options:players()[activePlayer()].cards,
					optionsText:'name'"
					></select>
				Fuel: <select data-bind="value:fuelToUse,options:possibleFuels"></select>

				<button data-bind="click:addCard"> Add Card</button><br>
				<button data-bind="click:declineToAdd"> No Action</button><br>
				<!-- ko if: !(game.cardActivePlayer()) -->
					<button data-bind="click:finalizeInvention"> Finalize Invention</button> <br>
					<button data-bind="click:skipInventing"> Skip Inventing</button> <br>
				<!-- /ko -->
				<div data-bind="if:cardForInvention"><span data-bind="text:cardForInvention().name"></span></div>
				Cards On Table <br>
				<div data-bind="foreach:cardsSelected" class="section">
					<span data-bind="text:name"></span><br>
				</div>
			<!-- /ko -->
			<div data-bind="foreach:players">
				<h5><div data-bind="text:name"></div></h5>
				Deck <br>
				<div data-bind="foreach:cards" class="section">
					<div data-bind="text:name"></div>
				</div>
				<div data-bind="foreach:constructions">
					<span data-bind="text:type.name"></span>:
					<span data-bind="text:number"></span>
					<!-- ko if:game.mode()=='mainView' -->
						toBuild: <input type="number" data-bind="value:toBuild">
						
						<span data-bind="text:type.useName"></span> :
						<input type="number" data-bind="value:toActivate"></input>
						<span data-bind="foreach:cost" class="costs">
							<span data-bind="text:resource"></span>:
							<span data-bind="text:value"></span>
						</span>
						<span data-bind="foreach:output" class="outputs">
							<span data-bind="text:resource"></span>:
							<span data-bind="text:value"></span>
						</span>

					<!-- /ko -->
					<br>
				</div>
			</div>
			<div data-bind="foreach:errors" class = "errors">
				<span data-bind="text:$data"></span><br>
			</div>

		</div>
	</body>
<html>