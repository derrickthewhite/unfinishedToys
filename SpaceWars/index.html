<!DOCTYPE html>
<html>
<head>
	<title>Space Wars</title>
	<link href="main.css" rel="stylesheet"></link>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.1/knockout-debug.js"></script>
	<script type="text/javascript" src="../../Tools/laconic.js"></script>
	<script type="text/javascript" src= "../../Tools/seededGenerator.js"></script>
	<!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js"></script>-->
	<!--<script type="text/javascript" src= "../../Tools/knockout-3.4.0.js"></script>-->
	<!--
	<script type="text/javascript" src= "https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.min.js"></script>
	<script type="text/javascript" src= "https://cdnjs.cloudflare.com/ajax/libs/require-text/2.0.12/text.js"></script>
	<!--<script type="text/javascript" src= "https://cdnjs.cloudflare.com/ajax/libs/require-text/2.0.12/text.min.js"></script>-->
	<!--<script type="text/javascript" src= "../../Tools/require.js"></script>-->
	<!-- Am I actually using Konva? I don't think so -->
	<!--
	<script src="https://cdn.rawgit.com/konvajs/konva/1.6.5/konva.js"></script>
	<script type="text/javascript" src= "../../Tools/knockout-konva.js"></script>
	-->
	<script type="text/javascript" src= "planetNames.js"></script>
	<script type="text/javascript" src= "planet.js"></script>
	<script type="text/javascript" src= "units.js"></script>
	<script type="text/javascript" src= "ArtificialIntelligence.js"></script>
	<script type="text/javascript" src= "diplomacy.js"></script>
	<script type="text/javascript" src= "galaxy.js"></script>
	<script type="text/javascript" src= "tick.js"></script>
	<script type="text/javascript" src= "game.js"></script>
	<script type="text/javascript" src= "view.js"></script>
	<!--  // TODO : build CSS! -->
	<script type="text/javascript" src= "config.js"></script>
	<script >

		var root = {};
		var battleRate = .1;
		//TODO: alter battle rate based on unit types and aggression
		function battleRound(a,b){
			return [a-b*battleRate,b-a*battleRate];
		}
		//TODO: alter distance based on ship flight type
		function distance(a,b){
			return Math.sqrt(Math.pow(ko.unwrap(a.x) -ko.unwrap(b.x),2) +Math.pow(ko.unwrap(a.y) -ko.unwrap(b.y),2));
		}
		//TODO: should random tools be in their own tools file?
		//fisher-yates shuffle algorithm
		function shuffleArray(a)
		{
			 var j, x, i;
			for (i = a.length - 1; i > 0; i--) {
				j = Math.floor(Math.random() * (i + 1));
				x = a[i];
				a[i] = a[j];
				a[j] = x;
			}
			return a;
		}
		function randomGausian(average,dev)
		{
			var u = 0, v = 0;
			while(u === 0) u = Math.random(); //Converting [0,1) to (0,1)
			while(v === 0) v = Math.random();
			var r = Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v );
			return average+r*dev;
		}
		//TODO: create interface between game and view
		
		var game = Game();
		var ai = {};
		function load(){
			//TODO: separate into game load and view load
			/*
				Interesting Seeds:
					9015: Big Green capital (Bacchus) with some supporters
					9413: Gap between the two sides
					2609: Green has most its power in the back
			*/
			var seed = Math.floor(Math.random()*10000);
			seed = "test";
			Math.seedrandom(seed);
			console.log("seed",seed);
			//Math.seedrandom("test");
			initConfig();
			var factions =[config.factionByName["English"],config.factionByName["Chinese"]];
			var playerTypes = [View,AI_Player];
			game.createGame(factions,playerTypes,config.map,20);

			root.game = game;
			root.view = game.players()[0];
			
			//TODO: more strongly associate this with view and separate from root
			ko.applyBindings(root,document.getElementById('content'));
			var canvas = document.getElementById('display');
			canvas.addEventListener("click",root.view.click);
			root.view.draw();
			root.view.drawMode = true; // TODO: why is draw mode after draw()? show draw set draw mode to true?
			game.runRound();
		}
		
		//TODO: give component an input option as well
		ko.components.register('FleetDisplay',{
			viewModel: function fleetForDisplay(params){
				this.units = params.units;
			},
			template:dom.div(
				{'data-bind':'foreach:units'},
				dom.div(
					dom.span({'data-bind':'text:count'}),
					" ",
					dom.span({'data-bind':'text:type.name'}),
					dom.span({'data-bind':'if:power()'},
						" with power ",
						dom.span({'data-bind':'text:power'})
					)
				)
			).outerHTML
		});
		
		ko.components.register("OrderDisplay",{
			viewModel: function (params){
				Object.keys(params).forEach(key => this[key]=params[key]);
			},
			template: dom.div(
				"Destination:",
				dom.span({"data-bind":"text:destination.name"}), 
				" at ",
				dom.span({"data-bind":"text:destination.x"}),
				", ",
				dom.span({"data-bind":"text:destination.y"}),
				" in ",
				dom.span({"data-bind":"text:time"}),
				" turns ",
				dom.div({"data-bind":"component: {name: 'FleetDisplay', params:fleet}"})
			).outerHTML
		});

	</script>
</head>
<body onload="load()">
	<div id = "content">
		<div>Current Player: <span data-bind="text:$root.view.activePlayer().name"></span></div>
		<div data-bind="with: ($root.view.viewMode() == 'fleet') && $root.view.currentMovingFleet()">
			<div data-bind="text:fleet.infoString"></div>
			<div>
				Moving to 
				<span data-bind="text:destination.x"></span>,
				<span data-bind="text:destination.y"></span>
				in
				<span data-bind="text:time"></span>
				Turns
			</div>
			<div data-bind="component: {name: 'FleetDisplay', params:fleet}"></div>
		</div>
		<div data-bind="with: ($root.view.viewMode() == 'order') && $root.view.currentOrder()">
			<div data-bind="text:fleet.infoString"></div>
			<div data-bind="component: {name: 'OrderDisplay', params:$data}"></div>
		</div>
		<div data-bind="with: ($root.view.viewMode() == 'planet') && $root.view.currentPlanet()">
			PLANET:
			<div data-bind = "text:name"></div>
			<div data-bind = "text:id"></div>
			<div > Industry: <span data-bind = "text:production"></span></div>
			<div > Produced: <span data-bind = "text:currentProduction().name"></span></div>
			<div > Producing: <span data-bind = "text:$root.view.planetProductionChange().name"></span></div>
			<div> Culture: <span data-bind = "text:culture.name"></span></div>
			<div> Status: <span data-bind = "text:status"></span></div>
			<div data-bind = "text:infoString"></div>
			<div data-bind="foreach:fleets">
				<div class = "fleet" data-bind="style: { 'background-color': owner().shading}">
				<div><span data-bind="text:owner().name"></span> Forces</div>
				<div data-bind = "text:infoString"></div>
				<div data-bind = "component: {name: 'FleetDisplay', params:$data}"></div>
				</div>
			</div>
			<div data-bind ="if:owner() == $root.view.activePlayer()">
				<select data-bind = "options:$root.view.planetProductionOptions, optionsText:'name', value:$root.view.workingProduction"></select>
				<button data-bind = "click:$root.view.setProductionForCurrentPlanet">Set Current Planet</button>
				<button data-bind = "click:$root.view.setProductionForAllMyPlanets">Set For All Planets</button>
			</div>
		</div>
		<div data-bind="if:$root.view.workingFleet.units().length">
			ORDER:
			<div data-bind="foreach:$root.view.workingFleet.units">
				<div>
					<input type = "number" data-bind = "value:count"></input>
					<span data-bind = "text:type.name"></span> 
					<span data-bind = "if:power()">
						with power
						<span data-bind = "text:power"></span>
					</span>
				</div>
			</div>
			
			<div data-bind ="if: $root.view.clickMode() == 'display'">
				<button data-bind = "click:$root.view.sendAll">Send All</button>
				<button data-bind = "click:$root.view.setDestination">Set Destination</button>
			</div>
		</div>
		<button data-bind = "click:$root.view.readyToTick">Tick</button>
	</div>
	<div id = "canvasFrame">
		<!-- canvas only shrinks properly if placed inside a div and THAT is manipulated-->
		<canvas id = "display" width="200" height="200"></canvas>
	</div>


</body>